name: Monthly Organ Audit

on:
  schedule:
    - cron: '0 2 1 * *'  # 1st of month, 2 AM UTC
  workflow_dispatch:  # Manual trigger

permissions:
  issues: write
  contents: write

jobs:
  audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Run Organ Audit
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 scripts/organ-audit.py \
            --registry registry-v2.json \
            --governance governance-rules.json \
            --output audit-report.md \
            --metrics metrics.json \
            --github

      - name: Create GitHub Issue with Report
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('audit-report.md', 'utf8');
            const metrics = JSON.parse(fs.readFileSync('metrics.json', 'utf8'));

            const date = new Date().toISOString().split('T')[0];

            const body = [
              report,
              '',
              '## System Metrics Summary',
              '',
              `| Metric | Value |`,
              `|--------|-------|`,
              `| Total repos | ${metrics.total_repos} |`,
              `| Operational organs | ${metrics.operational_organs}/${metrics.total_organs} |`,
              `| Completion | ${metrics.completion}% |`,
              `| Critical alerts | ${metrics.critical_alerts} |`,
              `| Warnings | ${metrics.warnings} |`,
              `| CI coverage | ${metrics.ci_coverage}/${metrics.total_repos} |`,
              `| Platinum repos | ${metrics.platinum_repos} |`,
              '',
              '---',
              '*Generated by ORGAN-IV monthly-organ-audit workflow*'
            ].join('\n');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Monthly Organ Audit — ${date}`,
              body: body,
              labels: ['audit', 'monthly']
            });

      - name: Append Metrics to Registry Audit History
        run: |
          python3 - <<'PYEOF'
          import json
          from datetime import datetime, timezone

          registry = json.load(open('registry-v2.json'))
          metrics = json.load(open('metrics.json'))

          if 'audit_history' not in registry:
              registry['audit_history'] = []

          registry['audit_history'].append({
              'date': datetime.now(timezone.utc).isoformat(),
              'metrics': metrics
          })

          # Keep only last 12 audit entries
          registry['audit_history'] = registry['audit_history'][-12:]

          with open('registry-v2.json', 'w') as f:
              json.dump(registry, f, indent=2)
              f.write('\n')
          PYEOF

      - name: Commit Updated Registry
        run: |
          git config user.name "ORGAN-IV Audit Bot"
          git config user.email "audit@organvm.org"
          git add registry-v2.json
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "audit: monthly metrics — $(date +%Y-%m-%d)"
            git push
          fi
